{{- bos_token }}
{%- if (messages|first).role == 'system' %}
    {%- set system_message = (messages|first).content|trim %}
    {%- set messages = messages[1:] %}
{%- else %}
    {%- set system_message = "detailed thinking on" %}
{%- endif %}
{{- "<|start_header_id|>system<|end_header_id|>\n\n" }}
{{- system_message }}
{{- "<|eot_id|>" }}
{%- for message in messages %}
    {%- if message.role == 'assistant' and '</think>' in message.content %}
        {%- set content = (message.content.split('</think>') | last).lstrip() %}
    {%- else %}
        {%- set content = message.content %}
    {%- endif %}
    {{- '<|start_header_id|>' + message.role + '<|end_header_id|>\n\n' + content | trim + '<|eot_id|>' }}
{%- endfor %}
{%- if add_generation_prompt %}
    {{- '<|start_header_id|>assistant<|end_header_id|>\n\n' }}
{%- endif %}